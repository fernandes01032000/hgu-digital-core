name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # Job 1: Testes
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: ğŸ§ª Run tests with pytest
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=term

    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Job 2: Linting
  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy bandit safety

    - name: ğŸ¨ Check code formatting with Black
      run: black --check src/ tests/

    - name: ğŸ“ Check import sorting with isort
      run: isort --check-only src/ tests/

    - name: ğŸ” Lint with flake8
      run: |
        # Stop the build if there are Python syntax errors or undefined names
        flake8 src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
        # Exit-zero treats all errors as warnings
        flake8 src/ tests/ --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

    - name: ğŸ”’ Security check with Bandit
      run: bandit -r src/ -ll

    - name: ğŸ›¡ï¸ Dependency security check with Safety
      run: safety check --json || true

  # Job 3: Type Checking
  type-check:
    name: Type Checking
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install mypy types-requests

    - name: ğŸ” Type check with mypy
      run: mypy src/ --ignore-missing-imports || true

  # Job 4: Build Check
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: âœ… Verify imports
      run: |
        python -c "from src.config import SERVER, SECURITY; print('âœ… Config imports OK')"
        python -c "from src.core.database import get_db_connection; print('âœ… Database imports OK')"
        python -c "from src.services.pdf_generator import gerar_pdf_documento; print('âœ… Services imports OK')"

    - name: ğŸ—ï¸ Test Flask app initialization
      run: |
        python -c "from app import app; print('âœ… Flask app OK'); print(f'âœ… Routes: {len(app.url_map._rules)}')"

  # Job 5: Documentation Check
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“ Check README
      run: |
        if [ ! -f README.md ]; then
          echo "âŒ README.md not found"
          exit 1
        fi
        echo "âœ… README.md exists"

    - name: ğŸ“ Check CHANGELOG
      run: |
        if [ ! -f CHANGELOG.md ]; then
          echo "âŒ CHANGELOG.md not found"
          exit 1
        fi
        echo "âœ… CHANGELOG.md exists"

    - name: ğŸ“ Check LICENSE
      run: |
        if [ ! -f LICENSE ]; then
          echo "âŒ LICENSE not found"
          exit 1
        fi
        echo "âœ… LICENSE exists"

  # Job 6: Success Summary
  success:
    name: âœ… All Checks Passed
    runs-on: ubuntu-latest
    needs: [test, lint, type-check, build, docs]
    if: success()

    steps:
    - name: ğŸ‰ Success
      run: |
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘   âœ… All CI/CD Checks Passed! ğŸ‰      â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… Tests passed on Python 3.8, 3.9, 3.10, 3.11"
        echo "âœ… Code quality checks passed"
        echo "âœ… Type checking passed"
        echo "âœ… Build verification passed"
        echo "âœ… Documentation is complete"
        echo ""
        echo "ğŸš€ Ready to merge!"
